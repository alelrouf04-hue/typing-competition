<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Competition - Online</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .word-highlight { color: #3b82f6; text-decoration: underline; font-weight: bold; }
        .word-correct { color: #10b981; }
        .word-wrong { color: #ef4444; }
        #input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ''; } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 font-sans">

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Area Game -->
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800">Typing Challenge üöÄ</h1>
                        <p id="status-user" class="text-slate-500 text-sm italic">Menghubungkan ke server...</p>
                    </div>
                    <button id="admin-trigger" class="text-xs text-slate-300 hover:text-slate-500">Admin</button>
                </div>

                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-blue-50 p-4 rounded-xl text-center border border-blue-100">
                        <p class="text-xs uppercase text-blue-600 font-semibold">Waktu</p>
                        <p id="timer" class="text-2xl font-bold">60s</p>
                    </div>
                    <div class="bg-emerald-50 p-4 rounded-xl text-center border border-emerald-100">
                        <p class="text-xs uppercase text-emerald-600 font-semibold">WPM</p>
                        <p id="wpm" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-xl text-center border border-purple-100">
                        <p class="text-xs uppercase text-purple-600 font-semibold">Akurasi</p>
                        <p id="accuracy" class="text-2xl font-bold">0%</p>
                    </div>
                </div>

                <div id="text-display" class="bg-slate-100 p-6 rounded-xl mb-6 text-xl leading-relaxed text-slate-700 font-mono select-none pointer-events-none min-h-[120px]">
                    Memuat tantangan...
                </div>

                <input type="text" id="input-field" disabled
                    class="w-full p-4 text-lg border-2 border-slate-200 rounded-xl transition-all font-mono opacity-50"
                    placeholder="Masukan nama dulu di kanan/atas...">
            </div>
        </div>

        <!-- Papan Skor -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow-xl p-6 h-full flex flex-col">
                <h2 class="text-xl font-bold text-slate-800 mb-4">üèÜ Skor Tertinggi</h2>
                <div id="leaderboard" class="space-y-3 overflow-y-auto max-h-[500px]">
                    <p class="text-slate-400 text-sm">Menghubungkan...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nama -->
    <div id="modal-nama" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full shadow-2xl">
            <h2 class="text-2xl font-bold mb-2">Selamat Datang!</h2>
            <p class="text-slate-500 mb-6 text-sm">Masukkan nama untuk berpartisipasi dalam kompetisi.</p>
            <input type="text" id="input-username" class="w-full p-3 border-2 border-slate-200 rounded-lg mb-4 outline-none focus:border-blue-500" placeholder="Nama Anda...">
            <button id="btn-submit-name" disabled class="w-full bg-blue-400 text-white py-3 rounded-lg font-bold cursor-not-allowed">
                <span id="btn-text" class="loading-dots">Menyiapkan Server</span>
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Config
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'typing-comp-123';

        let userUid = null;
        let userName = localStorage.getItem('typing_name') || "";
        
        // Game Logic Variables
        const texts = [
            "Pendidikan adalah kunci untuk membuka pintu emas kebebasan bagi semua orang di dunia.",
            "Teknologi digital berkembang sangat pesat dan mengubah cara kita bekerja setiap hari.",
            "Kesuksesan besar biasanya lahir dari pengorbanan kecil yang dilakukan secara konsisten."
        ];
        let currentWords = texts[Math.floor(Math.random() * texts.length)].split(" ");
        let wordIdx = 0;
        let startTime = null;
        let timer = 60;
        let isRunning = false;
        let correctChars = 0;
        let totalTyped = 0;

        // --- AUTH SECTION (RULE 3) ---
        async function startAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Fail:", err);
                document.getElementById('btn-text').innerText = "Gagal Terhubung";
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userUid = user.uid;
                const btn = document.getElementById('btn-submit-name');
                btn.disabled = false;
                btn.classList.remove('bg-blue-400', 'cursor-not-allowed');
                btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                document.getElementById('btn-text').innerText = "Mulai Bermain";
                document.getElementById('status-user').innerText = "Terhubung ke Server";
                
                if (userName) {
                    closeModalAndStart();
                }
                loadLeaderboard();
            }
        });

        // --- FIRESTORE SECTION ---
        function loadLeaderboard() {
            if (!userUid) return;
            // Rule 1: Strict Path
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            onSnapshot(q, (snapshot) => {
                const data = [];
                snapshot.forEach(d => data.push(d.data()));
                // Rule 2: Sort in memory
                data.sort((a, b) => b.wpm - a.wpm);
                
                const html = data.map((s, i) => `
                    <div class="flex items-center justify-between p-3 rounded-lg ${s.uid === userUid ? 'bg-blue-50 border border-blue-200' : 'bg-slate-50'}">
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-slate-400 w-5">#${i+1}</span>
                            <span class="font-bold text-slate-700">${s.name}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-blue-600 font-black">${s.wpm}</span> <span class="text-[10px] text-slate-400">WPM</span>
                        </div>
                    </div>
                `).join("");
                document.getElementById('leaderboard').innerHTML = html || '<p class="text-slate-400 text-sm italic">Belum ada skor.</p>';
            }, (err) => {
                console.error("Leaderboard Error:", err);
            });
        }

        async function saveScore(wpm, acc) {
            if (!userUid || !userName) return;
            const scoreDoc = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', userUid);
            await setDoc(scoreDoc, {
                uid: userUid,
                name: userName,
                wpm: wpm,
                acc: acc,
                timestamp: Date.now()
            });
        }

        // --- GAME UI SECTION ---
        function closeModalAndStart() {
            document.getElementById('modal-nama').classList.add('hidden');
            document.getElementById('status-user').innerText = "Pemain: " + userName;
            document.getElementById('input-field').disabled = false;
            document.getElementById('input-field').classList.remove('opacity-50');
            document.getElementById('input-field').placeholder = "Mulai mengetik...";
            renderText();
        }

        function renderText() {
            const display = document.getElementById('text-display');
            display.innerHTML = currentWords.map((w, i) => `<span id="w-${i}">${w}</span>`).join(" ");
            document.getElementById(`w-${wordIdx}`).className = 'word-highlight';
        }

        document.getElementById('btn-submit-name').onclick = () => {
            const val = document.getElementById('input-username').value.trim();
            if (val) {
                userName = val;
                localStorage.setItem('typing_name', val);
                closeModalAndStart();
            }
        };

        document.getElementById('input-field').oninput = function() {
            if (!isRunning) {
                isRunning = true;
                startTime = Date.now();
                const timerInt = setInterval(() => {
                    timer--;
                    document.getElementById('timer').innerText = timer + "s";
                    if (timer <= 0) {
                        clearInterval(timerInt);
                        finishGame();
                    }
                }, 1000);
            }

            const val = this.value;
            const target = currentWords[wordIdx];

            if (val.endsWith(" ") || (wordIdx === currentWords.length - 1 && val === target)) {
                const typed = val.trim();
                const el = document.getElementById(`w-${wordIdx}`);
                if (typed === target) {
                    el.className = 'word-correct';
                    correctChars += target.length + 1;
                } else {
                    el.className = 'word-wrong';
                }
                totalTyped += typed.length + 1;
                wordIdx++;
                this.value = "";
                if (wordIdx < currentWords.length) {
                    document.getElementById(`w-${wordIdx}`).className = 'word-highlight';
                } else {
                    finishGame();
                }
            }
            updateLiveStats();
        };

        function updateLiveStats() {
            const elapsed = (Date.now() - startTime) / 60000 || 0.01;
            const wpm = Math.round((correctChars / 5) / elapsed);
            const acc = totalTyped > 0 ? Math.round((correctChars / totalTyped) * 100) : 0;
            document.getElementById('wpm').innerText = wpm;
            document.getElementById('accuracy').innerText = acc + "%";
        }

        async function finishGame() {
            isRunning = false;
            document.getElementById('input-field').disabled = true;
            const finalWpm = parseInt(document.getElementById('wpm').innerText);
            const finalAcc = parseInt(document.getElementById('accuracy').innerText);
            
            await saveScore(finalWpm, finalAcc);
            alert(`Selesai! Skor Anda: ${finalWpm} WPM. Skor telah disimpan ke papan skor global.`);
            location.reload();
        }

        // Admin Reset
        document.getElementById('admin-trigger').onclick = async () => {
            const pass = prompt("Password Admin:");
            if (pass === "admin123") {
                if (confirm("Hapus semua skor di papan skor?")) {
                    const q = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
                    const snap = await getDocs(q);
                    snap.forEach(async (d) => await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', d.id)));
                    alert("Leaderboard dibersihkan.");
                }
            }
        };

        startAuth();
    </script>
</body>
</html>